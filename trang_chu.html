<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Email AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .preview-text { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .priority-badge { font-size: 0.85rem; padding: 0.45em; }
        .new-email { background-color: #f0f8ff; } /* m√†u n·ªÅn nh·∫π cho email ch∆∞a x·ª≠ l√Ω */
        .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1055; }
    </style>
</head>
<body class="bg-light">

<!-- Header -->
<div class="header position-relative text-white" 
     style="background: linear-gradient(rgba(35, 32, 32, 0.3), rgba(35, 32, 32, 0.3)), url('/static/header.png') no-repeat center center; background-size: cover; padding: 80px 20px; height:200px;">
    <a href="{{ url_for('refresh') }}" class="btn btn-outline-light position-absolute top-0 start-0 m-3">üîÑ L√†m m·ªõi</a>
    <h1 class="fw-bold text-center" style="margin:0; position: absolute; top:50%; left:50%; transform: translate(-50%, -50%);">
        üì© PH√ÇN LO·∫†I V√Ä ∆ØU TI√äN EMAIL KH√ÅCH H√ÄNG
    </h1>
    {% if session.username %}
        <div class="position-absolute bottom-0 end-0 m-3 d-flex align-items-center gap-2">
            <span class="fw-bold">Xin ch√†o, {{ session.username }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm mt-2">ƒêƒÉng xu·∫•t</a>
        </div>
    {% endif %}
</div>

<!-- B·ªô l·ªçc + t√¨m ki·∫øm -->
<div class="container my-4">
    <div class="card shadow-sm p-3">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold">L·ªçc theo lo·∫°i email:</label>
                <select id="locLoai" class="form-select">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="Khi·∫øu n·∫°i">Khi·∫øu n·∫°i</option>
                    <option value="ƒê·∫∑t h√†ng">ƒê·∫∑t h√†ng</option>
                    <option value="H·ªèi ƒë√°p">H·ªèi ƒë√°p</option>
                    <option value="G√≥p √Ω">G√≥p √Ω</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">L·ªçc theo m·ª©c ∆∞u ti√™n:</label>
                <select id="locUuTien" class="form-select">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="Cao">Cao</option>
                    <option value="Trung b√¨nh">Trung b√¨nh</option>
                    <option value="Th·∫•p">Th·∫•p</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">T√¨m ki·∫øm nhanh:</label>
                <input type="text" id="searchEmail" class="form-control" placeholder="T√¨m theo ti√™u ƒë·ªÅ, n·ªôi dung ho·∫∑c email ng∆∞·ªùi g·ª≠i">
            </div>
        </div>
    </div>
</div>

<!-- Danh s√°ch Email -->
<div class="container">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white fw-bold">
            Danh s√°ch Email ƒë√£ x·ª≠ l√Ω
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light text-center">
                    <tr>
                        <th>STT</th>
                        <th>Ti√™u ƒë·ªÅ</th>
                        <th>N·ªôi dung</th>
                        <th>Email ng∆∞·ªùi g·ª≠i</th>
                        <th>Th·ªùi gian g·ª≠i</th>
                        <th>∆Øu ti√™n</th>
                        <th>G·ª£i √Ω ph·∫£n h·ªìi</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="dsEmail">
                    {% for e in emails %}
                    <tr class="email-row text-center {% if not e.da_xu_ly %}new-email{% endif %}" 
                        data-loai="{{ e.tieu_de }}" data-uutien="{{ e.uu_tien }}" data-status="{{ 'da' if e.da_xu_ly else 'chua' }}">
                        <td>{{ e.stt }}</td>
                        <td class="fw-bold text-primary">{{ e.tieu_de }}</td>
                        <!-- Preview 40 k√Ω t·ª± -->
                        <td class="preview-text" title="{{ e.noi_dung }}">{{ e.noi_dung[:40] }}...</td>
                        <td class="text-muted">{{ e.email_khach }}</td>
                        <td class="text-muted">{{ e.thoi_gian_gui }}</td>
                        <td>
                            {% if e.uu_tien|lower == "cao" %}
                                <span class="badge bg-danger priority-badge">Cao</span>
                            {% elif e.uu_tien|lower == "trung b√¨nh" %}
                                <span class="badge bg-warning text-dark priority-badge">Trung b√¨nh</span>
                            {% else %}
                                <span class="badge bg-success priority-badge">Th·∫•p</span>
                            {% endif %}
                        </td>
                        <td>
                            <span data-bs-toggle="tooltip" title="{{ e.goiy }}">{{ e.goiy[:30] }}...</span>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    ...
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="sendReply({{ e.stt }})">üì§ Tr·∫£ l·ªùi nhanh</a></li>
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modal{{ e.stt }}">üìÑ Xem chi ti·∫øt</a></li>
                                    <li><a class="dropdown-item text-success" href="#" onclick="markRead({{ e.stt }}, this)">‚úÖ ƒê√°nh d·∫•u ƒë√£ x·ª≠ l√Ω</a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>

                    <!-- Modal xem n·ªôi dung -->
                    <div class="modal fade" id="modal{{ e.stt }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">N·ªôi dung email</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Ti√™u ƒë·ªÅ:</strong> {{ e.tieu_de }}</p>
                                    <p><strong>N·ªôi dung:</strong></p>
                                    <pre>{{ e.noi_dung }}</pre>
                                    <p><strong>Email ng∆∞·ªùi g·ª≠i:</strong> {{ e.email_khach }}</p>
                                    <p><strong>Th·ªùi gian g·ª≠i:</strong> {{ e.thoi_gian_gui }}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Toast container -->
<div class="toast-container"></div>

<!-- Footer -->
<footer class="bg-primary text-white text-center py-3 mt-5">
    &copy; {{ current_year }} Ph√¢n lo·∫°i v√† ∆∞u ti√™n Email b·∫±ng AI - L∆∞∆°ng Th·ªã Tr√† My / Nguy·ªÖn M·∫°nh Tu√¢n
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Tooltip
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (el) {
        return new bootstrap.Tooltip(el)
    })

    // L·ªçc + t√¨m ki·∫øm
    document.getElementById("locLoai").addEventListener("change", filterEmail);
    document.getElementById("locUuTien").addEventListener("change", filterEmail);
    document.getElementById("searchEmail").addEventListener("input", filterEmail);

    function filterEmail() {
        const loai = document.getElementById("locLoai").value.toLowerCase();
        const uuTien = document.getElementById("locUuTien").value.toLowerCase();
        const search = document.getElementById("searchEmail").value.toLowerCase();

        document.querySelectorAll(".email-row").forEach(row => {
            const rowLoai = row.dataset.loai.toLowerCase();
            const rowUuTien = row.dataset.uutien.toLowerCase();
            const title = row.cells[1].textContent.toLowerCase();
            const content = row.cells[2].textContent.toLowerCase();
            const email = row.cells[3].textContent.toLowerCase();

            const matchLoai = !loai || rowLoai.includes(loai);
            const matchUuTien = !uuTien || rowUuTien === uuTien;
            const matchSearch = !search || title.includes(search) || content.includes(search) || email.includes(search);

            row.style.display = (matchLoai && matchUuTien && matchSearch) ? "" : "none";
        });
    }

    // G·ª≠i email AJAX
    async function sendReply(stt) {
        try {
            const response = await fetch(`/reply_ajax/${stt}`, { method: 'POST' });
            const data = await response.json();
            showToast(data.message, data.status === "success" ? "success" : "danger");
        } catch (error) {
            showToast("L·ªói khi g·ª≠i email: " + error, "danger");
        }
    }

    // ƒê√°nh d·∫•u ƒë√£ x·ª≠ l√Ω
    function markRead(stt, el) {
        const row = el.closest("tr");
        row.classList.remove("new-email");
        showToast("ƒê√£ ƒë√°nh d·∫•u email #" + stt + " l√† ƒë√£ x·ª≠ l√Ω", "success");
    }

    // Toast hi·ªÉn th·ªã
    function showToast(message, type="success") {
        const container = document.querySelector(".toast-container");
        const toastEl = document.createElement("div");
        toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
        toastEl.role = "alert";
        toastEl.innerHTML = `<div class="d-flex">
                                <div class="toast-body">${message}</div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                             </div>`;
        container.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        toast.show();
        toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
    }
</script>

</body>
</html>
